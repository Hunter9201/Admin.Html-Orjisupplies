<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Orji Admin — Push to GitHub</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--brand:#0ea5e9;--ok:#16a34a;--bad:#ef4444}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#f8fafc;color:var(--ink)}
  header{padding:14px 16px;border-bottom:1px solid var(--line);background:#fff}
  h1{margin:0;font-size:20px}
  .wrap{max-width:1100px;margin:16px auto;padding:0 16px;display:grid;grid-template-columns:320px 1fr;gap:16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  label{font-weight:600;font-size:13px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;margin-top:6px;font-size:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .stack{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:800;cursor:pointer}
  .primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .good{color:var(--ok)} .bad{color:var(--bad)}
  .list{font-size:14px;color:var(--muted);max-height:320px;overflow:auto}
  code{background:#f1f5f9;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
  .hint{font-size:12px;color:var(--muted)}
  @media (max-width:900px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>
<header><h1>Orji Admin — Update products.json in Orji-Supplies</h1></header>

<div class="wrap">
  <!-- Settings -->
  <div class="card">
    <h3>GitHub Settings</h3>
    <div class="row">
      <div>
        <label>Owner (username/org)
          <input id="ghOwner" placeholder="hunter9201">
        </label>
      </div>
      <div>
        <label>Repo (shop repo)
          <input id="ghRepo" placeholder="Orji-Supplies">
        </label>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Branch
          <input id="ghBranch" placeholder="main" value="main">
        </label>
      </div>
      <div>
        <label>Images folder
          <input id="imgDir" placeholder="images" value="images">
        </label>
      </div>
    </div>
    <label>GitHub Token (classic, scope: <code>public_repo</code>)
      <input id="ghToken" type="password" placeholder="ghp_...">
    </label>
    <div class="stack">
      <button class="button" onclick="saveCfg()">Save Settings</button>
      <button class="button" onclick="loadCfg()">Load</button>
      <span id="cfgMsg" class="hint"></span>
    </div>
    <hr>
    <div class="stack">
      <button class="button" onclick="previewProducts()">Preview products.json</button>
      <button class="button" onclick="pullProducts()">Pull from GitHub</button>
    </div>
    <div id="pullStatus" class="hint" style="margin-top:6px"></div>
    <div id="previewBox" class="list" style="margin-top:10px"></div>
  </div>

  <!-- Product form -->
  <div class="card">
    <h3>Add / Edit Product</h3>
    <div class="row">
      <div>
        <label>Product ID
          <input id="pId" placeholder="pUnique123">
        </label>
      </div>
      <div>
        <label>Name
          <input id="pName" placeholder="Harpic Power Plus 10X (750ml)">
        </label>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Retail Price (UGX)
          <input id="pRetail" type="number" min="0" placeholder="16000">
        </label>
      </div>
      <div>
        <label>Wholesale Price (UGX)
          <input id="pWholesale" type="number" min="0" placeholder="14000">
        </label>
      </div>
    </div>
    <div class="row">
      <div>
        <label>MOQ (for wholesale)
          <input id="pMoq" type="number" min="1" value="12">
        </label>
      </div>
      <div>
        <label>Unit
          <input id="pUnit" placeholder="bottle">
        </label>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Category
          <select id="pCat">
            <option value="laundry">laundry</option>
            <option value="home">home</option>
            <option value="accessories">accessories</option>
            <option value="pest">pest</option>
          </select>
        </label>
      </div>
      <div>
        <label>Rating (e.g. 4.6)
          <input id="pRating" type="number" min="0" max="5" step="0.1" value="4.6">
        </label>
      </div>
    </div>
    <label>Description
      <textarea id="pDesc" rows="3" placeholder="Powerful toilet cleaner for tough stains and germs."></textarea>
    </label>
    <div class="row">
      <div>
        <label>Tag (optional)
          <input id="pTag" placeholder="Bestseller">
        </label>
      </div>
      <div>
        <label>Image URLs (optional, comma-separated)
          <input id="pImgUrls" placeholder="https://... , https://...">
        </label>
      </div>
    </div>
    <label>Or upload images (1–4)
      <input id="pImgs" type="file" accept="image/*" multiple>
    </label>
    <div class="hint">If you choose files, they will be uploaded into <code>images/</code> of your shop repo and linked in products.json.</div>

    <div class="stack">
      <button class="button primary" onclick="addProduct()">Add to List</button>
      <button class="button" onclick="clearForm()">Clear Form</button>
      <span id="formMsg" class="hint"></span>
    </div>

    <hr>
    <h3>Current Products (staged)</h3>
    <div id="stagedBox" class="list"></div>
    <div class="stack">
      <button class="button primary" onclick="pushToGitHub()">Save to GitHub (products.json + images)</button>
      <span id="pushMsg" class="hint"></span>
    </div>
  </div>
</div>

<script>
  const CFG_KEY = 'ORJI_ADMIN_CFG_V1';
  const RAW_JSON_PATH = 'products.json'; // stored at repo root
  let staged = []; // products staged locally (in memory) for saving

  function saveCfg(){
    const cfg = {
      owner: ghOwner.value.trim(),
      repo: ghRepo.value.trim(),
      branch: ghBranch.value.trim() || 'main',
      imgDir: imgDir.value.trim() || 'images',
      token: ghToken.value.trim()
    };
    localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
    cfgMsg.textContent = 'Saved.';
  }
  function loadCfg(){
    try{
      const cfg = JSON.parse(localStorage.getItem(CFG_KEY)||'{}');
      ghOwner.value = cfg.owner||'';
      ghRepo.value = cfg.repo||'';
      ghBranch.value = cfg.branch||'main';
      imgDir.value = cfg.imgDir||'images';
      ghToken.value = cfg.token||'';
      cfgMsg.textContent = 'Loaded.';
    }catch(e){ cfgMsg.textContent='No saved settings.' }
  }
  loadCfg();

  async function pullProducts(){
    pullStatus.textContent = 'Fetching products.json from GitHub...';
    try{
      const url = `https://raw.githubusercontent.com/${ghOwner.value}/${ghRepo.value}/${ghBranch.value}/${RAW_JSON_PATH}`;
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok){ pullStatus.textContent = 'products.json not found yet (will be created on first push).'; previewBox.textContent=''; return; }
      const data = await r.json();
      staged = Array.isArray(data)? data : [];
      pullStatus.textContent = `Loaded ${staged.length} products from GitHub.`;
      renderStaged();
      previewBox.textContent = JSON.stringify(staged, null, 2);
    }catch(e){
      pullStatus.textContent = 'Error fetching products.json';
    }
  }

  function renderStaged(){
    stagedBox.innerHTML = staged.length
      ? staged.map(p=>`• <strong>${p.name}</strong> — UGX ${p.retailPrice} / ${p.unit||'piece'} ${p.imgs&&p.imgs.length?`<span class="hint">(${p.imgs.length} img)</span>`:''}`).join('<br>')
      : '<em>No products staged yet.</em>';
  }

  function clearForm(){
    pId.value=''; pName.value=''; pRetail.value=''; pWholesale.value='';
    pMoq.value='12'; pUnit.value=''; pCat.value='laundry'; pRating.value='4.6';
    pDesc.value=''; pTag.value=''; pImgUrls.value=''; pImgs.value='';
    formMsg.textContent='';
  }

  function uniqueFileName(original){
    const base = original.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9.\-]/g,'');
    const stamp = Date.now().toString(36);
    const parts = base.split('.');
    const ext = parts.length>1 ? '.'+parts.pop() : '';
    const stem = parts.join('.') || 'img';
    return `${stem}-${stamp}${ext||'.jpg'}`;
  }

  async function fileToBase64(file){
    const buf = await file.arrayBuffer();
    let binary = '';
    const bytes = new Uint8Array(buf);
    const chunkSize = 0x8000;
    for (let i=0;i<bytes.length;i+=chunkSize){
      const chunk = bytes.subarray(i,i+chunkSize);
      binary += String.fromCharCode.apply(null, chunk);
    }
    return btoa(binary);
  }

  function addProduct(){
    const id = pId.value.trim();
    const name = pName.value.trim();
    if(!id || !name){ formMsg.textContent='ID and Name are required.'; return; }
    const prod = {
      id,
      name,
      retailPrice: Number(pRetail.value||0),
      wholesalePrice: Number(pWholesale.value||0),
      moq: Number(pMoq.value||1),
      category: pCat.value,
      unit: pUnit.value||'piece',
      desc: pDesc.value||'',
      rating: Number(pRating.value||0) || undefined,
      tag: pTag.value||undefined,
      imgs: []
    };
    // URLs
    const urls = (pImgUrls.value||'').split(',').map(s=>s.trim()).filter(Boolean);
    prod.imgs.push(...urls);
    // Files — we don't upload now; we stage them by keeping File objects in a temp map keyed by prod.id
    const files = Array.from(pImgs.files||[]);
    if(files.length){ prod._files = files; } // temp field used only at push
    // Replace if same id exists
    const idx = staged.findIndex(x=>x.id===id);
    if(idx>=0) staged.splice(idx,1,prod); else staged.push(prod);
    formMsg.textContent = 'Staged. Remember to "Save to GitHub".';
    renderStaged();
  }

  async function pushToGitHub(){
    const cfg = JSON.parse(localStorage.getItem(CFG_KEY)||'{}');
    if(!cfg.owner || !cfg.repo || !cfg.branch || !cfg.token){ pushMsg.textContent='Please fill GitHub settings and Save.'; return; }
    pushMsg.textContent = 'Uploading images (if any)...';

    // 1) Upload files to images/ and replace prod._files with relative paths
    for (const prod of staged){
      if(prod._files && prod._files.length){
        for (const f of prod._files){
          const filename = uniqueFileName(f.name||'image.jpg');
          const path = `${cfg.imgDir}/${filename}`.replace(/\/+/g,'/');
          const contentB64 = await fileToBase64(f);
          const putUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
          const putRes = await fetch(putUrl, {
            method:'PUT',
            headers:{'Authorization':`Bearer ${cfg.token}`,'Content-Type':'application/json'},
            body: JSON.stringify({
              message: `Add image ${filename}`,
              content: contentB64,
              branch: cfg.branch
            })
          });
          if(!putRes.ok){
            const txt = await putRes.text();
            pushMsg.textContent = `Image upload failed: ${txt}`;
            return;
          }
          // store relative path for shop (images/filename)
          prod.imgs = prod.imgs || [];
          prod.imgs.push(path);
        }
        delete prod._files;
      }
    }

    // 2) Get current products.json sha (if exists)
    pushMsg.textContent = 'Preparing products.json...';
    let sha = null;
    const getUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(RAW_JSON_PATH)}?ref=${encodeURIComponent(cfg.branch)}`;
    const getRes = await fetch(getUrl, {headers:{'Authorization':`Bearer ${cfg.token}`}});
    if(getRes.ok){
      const meta = await getRes.json();
      sha = meta.sha || null;
    }

    // 3) PUT products.json
    const contentB64 = btoa(unescape(encodeURIComponent(JSON.stringify(staged, null, 2))));
    const putRes = await fetch(`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(RAW_JSON_PATH)}`, {
      method:'PUT',
      headers:{'Authorization':`Bearer ${cfg.token}`,'Content-Type':'application/json'},
      body: JSON.stringify({
        message: 'Update products.json',
        content: contentB64,
        branch: cfg.branch,
        sha
      })
    });
    if(!putRes.ok){
      const txt = await putRes.text();
      pushMsg.textContent = `products.json save failed: ${txt}`;
      return;
    }
    pushMsg.innerHTML = `<span class="good">Done!</span> Your shop will read <code>${RAW_JSON_PATH}</code> and show these items on any device.`;
  }

  function previewProducts(){
    previewBox.textContent = JSON.stringify(staged, null, 2);
  }
</script>
</body>
</html>
